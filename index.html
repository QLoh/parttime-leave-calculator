// 執行計算
function goStep3() {
  const wage = parseFloat(document.getElementById("wage").value) || 0;
  const weekHours = parseFloat(document.getElementById("weekHours").value) || 0;
  
  // 特休參數
  const seniority = parseFloat(document.getElementById("seniority").value) || 0;
  const annualHours = parseFloat(document.getElementById("annualHours").value) || 0;
  
  // 婚喪病參數
  const legalDays = parseFloat(document.getElementById("legalDays").value) || 0;
  
  // 生理假參數
  const shiftHours = parseFloat(document.getElementById("shiftHours").value) || 0;

  // 產假參數 (Checkbox)
  const isMaternityFull = document.getElementById("maternitySeniority").checked;

  let resultHTML = "";
  let formulaHTML = "<strong>運算公式說明：</strong><br>";

  // 這裡是重點：所有假別判斷都要在同一個 forEach 裡面
  selectedLeaves.forEach(type => {
    
    // === A. 特休假 ===
    if (type === "vacation") {
        let ftDays = 0;
        let baseHours = 2088; 

        if (seniority >= 0.5 && seniority < 1) {
            ftDays = 3;
            baseHours = 1044; 
        } 
        else if (seniority >= 1 && seniority < 2) ftDays = 7;
        else if (seniority >= 2 && seniority < 3) ftDays = 10;
        else if (seniority >= 3 && seniority < 5) ftDays = 14;
        else if (seniority >= 5 && seniority < 10) ftDays = 15;
        else if (seniority >= 10) ftDays = 15 + (Math.floor(seniority) - 10);
        
        if (ftDays > 30) ftDays = 30;

        let hours = (annualHours / baseHours) * ftDays * 8;
        
        resultHTML += `<p><strong>【特休假】</strong><br>
            全時基準：${ftDays} 天 (對應基數 ${baseHours}hr)<br>
            比例折算：<b>${hours.toFixed(2)} 小時</b>。<br>
            若全部折現，應發金額：NT$${Math.round(hours * wage)}</p>`;
        
        formulaHTML += `‣ 特休時數 = (實際工時 ${annualHours} ÷ 基準 ${baseHours}) × 天數 ${ftDays} × 8<br>`;
    }

    // === B. 產假 (8週) ===
    if (type === "maternity") {
      let payHours = weekHours * 8; 
      let rate = isMaternityFull ? 1.0 : 0.5;
      let rateText = isMaternityFull ? "全薪" : "半薪 (年資未滿半年)";
      let salary = payHours * wage * rate;

      resultHTML += `<p><strong>【產假 (8週)】</strong><br>
        薪資基準為 <b>${payHours.toFixed(2)} 小時</b> (${rateText})。<br>
        預估薪資：NT$${Math.round(salary)}</p>`;
        
      formulaHTML += `‣ 產假薪資 = (平均週工時${weekHours} × 8週) × 時薪 × ${rate}<br>`;
    }

    // === C. 生理假 ===
    if (type === "menstrual") {
      let salary = shiftHours * wage * 0.5;
      resultHTML += `<p><strong>【生理假】</strong><br>
        當日排班 ${shiftHours} 小時，半薪計算。<br>
        應發薪資：NT$${Math.round(salary)}</p>`;
      formulaHTML += `‣ 生理假薪資 = 當日排班${shiftHours} × 時薪 × 0.5<br>`;
    }

    // === D. 婚/喪/病/事 (依比例) ===
    if (["marriage", "funeral", "sick", "personal"].includes(type)) {
      let name = leaveNames[type];
      let ratioHours = (weekHours / 40) * legalDays * 8;
      let payRate = 1; 
      let rateName = "全薪";

      if (type === "sick") { payRate = 0.5; rateName = "半薪"; }
      if (type === "personal") { payRate = 0; rateName = "無薪"; }

      let money = ratioHours * wage * payRate;

      resultHTML += `<p><strong>【${name}】</strong><br>
        依比例折算為 <b>${ratioHours.toFixed(2)} 小時</b>。<br>
        應發薪資 (${rateName})：NT$${Math.round(money)}</p>`;
      
      formulaHTML += `‣ ${name}時數 = (週工時${weekHours} ÷ 40) × 天數${legalDays} × 8<br>`;
    }
  }); // 所有的 if 判斷都結束後，才在這裡結束 forEach

  document.getElementById("results").innerHTML = resultHTML;
  document.getElementById("formulas").innerHTML = formulaHTML;

  document.getElementById("step2").style.display = "none";
  document.getElementById("step3").style.display = "block";
}
